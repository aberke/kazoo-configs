modparam("htable", "htable", "m=>size=32;autoexpire=60;")


event_route[kazoo:consumer-event-message-route]
{
    xlog("L_INFO", "received message route for $(kzE{kz.json,Endpoints[0].To-DID})");
    $var(to_uri) = "sip:" + $(kzE{kz.json,Endpoints[0].To-Username}) + "@" + $(kzE{kz.json,Endpoints[0].To-Realm});
    $sht(m=>$(kzE{kz.json,Call-ID})) = $kzE;
    lookup("location", "$var(to_uri)");
    $uac_req(method)="MESSAGE";
    $uac_req(body)= $(kzE{kz.json,Body});
    $uac_req(hdrs)="Content-Type: text/plain\r\n";
    $uac_req(turi) = $var(to_uri);
    $uac_req(ruri) = $ruri;
    $var(from_uri) = "sip:" + $(kzE{kz.json,Caller-ID-Number}) + "@" + $(kzE{kz.json,Endpoints[0].To-Realm});
    $uac_req(furi) = $var(from_uri);
    $uac_req(callid) = $(kzE{kz.json,Call-ID});
    xlog("L_INFO", "sending message from $var(from_uri) to $var(to_uri) - $ruri");
    uac_req_send();

}

route[MESSAGE_REPLY]
{
    if($T_reply_code != 200 && $T_reply_code != 202) {
       exit();
    }
    $var(Payload) = "{ 'Event-Category' : 'message', 'Event-Name' : 'delivery',  'Call-ID' : '" + $(sht(m=>$ci){kz.json,Call-ID}) + "', 'Message-ID' : '" + $(sht(m=>$ci){kz.json,Message-ID}) +"' , 'Delivery-Result-Code' : 'sip:200' , 'Msg-ID' : '" + $(sht(m=>$ci){kz.json,Msg-ID}) + "' , 'Status' : 'Success'}";

    $var(RoutingKey) = $(sht(m=>$ci){kz.json,Server-ID});
    $var(exchange) = "targeted";
    if($var(RoutingKey) == "") {
       $var(exchange) = "sms";
       $var(RoutingKey) = "message.delivery." + $(sht(m=>$ci){kz.json,Call-ID}{kz.encode});
    }    
    xlog("L_INFO", "sending delivery message for $ci");
    kazoo_publish($var(exchange), $var(RoutingKey), $var(Payload));
}


# vim: tabstop=4 softtabstop=4 shiftwidth=4 expandtab
